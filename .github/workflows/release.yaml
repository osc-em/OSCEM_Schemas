---
name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  release:
    name: Build and publish release artifacts
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install Poetry
        run: |
          pipx install poetry
          poetry self add "poetry-dynamic-versioning[plugin]"

      - name: Install dependencies
        run: poetry install --no-interaction

      # Generate artifacts once, use everywhere
      - name: Generate project artifacts
        run: make gen-all-schemas

      # 1. Deploy to GitHub Pages for permanent URLs
      - name: Prepare artifacts for GitHub Pages
        run: |
          mkdir -p artifacts-pages
          VERSION="${{ github.event.release.tag_name }}"

          echo "Deploying version: $VERSION"

          # Create version directories (clean latest to avoid stale files)
          mkdir -p "artifacts-pages/$VERSION"
          rm -rf "artifacts-pages/latest"
          mkdir -p "artifacts-pages/latest"

          # Copy to versioned directory and latest
          cp -r project/* "artifacts-pages/$VERSION/"
          cp -r project/* "artifacts-pages/latest/"

          # Generate index pages for current version and latest
          poetry run python scripts/generate_index_pages.py project "artifacts-pages/latest" "latest"
          poetry run python scripts/generate_index_pages.py project "artifacts-pages/$VERSION" "$VERSION"

      - name: Regenerate index pages for existing versions if missing
        run: |
          set -e

          # Save current branch/ref to restore later
          CURRENT_REF=$(git rev-parse HEAD)

          # Fetch gh-pages branch
          git fetch origin gh-pages || exit 0

          # Extract artifacts directory
          git show origin/gh-pages:artifacts 2>/dev/null || { echo "No existing artifacts to update"; exit 0; }

          # List version directories from gh-pages
          VERSIONS=$(git ls-tree --name-only origin/gh-pages:artifacts | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          if [ -z "$VERSIONS" ]; then
            echo "No previous versions found"
            exit 0
          fi

          for version in $VERSIONS; do
            # Check if this version has subdirectory indexes by counting index.html files
            HAS_INDEXES=$(git ls-tree -r origin/gh-pages:artifacts/$version | grep '/index.html$' | wc -l)

            # If only 1 index.html exists (the top-level one), subdirectory indexes are missing
            if [ "$HAS_INDEXES" -le 1 ]; then
              echo "Regenerating missing index pages for $version"

              # Extract this version's artifacts from gh-pages to artifacts-pages/$version
              mkdir -p "artifacts-pages/$version"
              git archive origin/gh-pages "artifacts/$version" | tar -x --strip-components=2 -C "artifacts-pages/$version"

              # Create symlinks for consistent naming (short name -> full oscem_schemas_* name)
              cd "artifacts-pages/$version"
              for short_name in cellular_tomo env_tomo general spa subtomo; do
                if [ -d "$short_name" ] && [ ! -e "oscem_schemas_$short_name" ]; then
                  ln -s "$short_name" "oscem_schemas_$short_name"
                  echo "Created symlink: oscem_schemas_$short_name -> $short_name"
                fi
              done
              cd - > /dev/null

              # Generate index pages (will also create index pages for symlinked directories)
              poetry run python scripts/generate_index_pages.py "artifacts-pages/$version" "artifacts-pages/$version" "$version"
            else
              echo "Skipping $version - already has $HAS_INDEXES index pages"
            fi
          done

          git checkout -q "$CURRENT_REF"

      - name: Generate artifacts documentation page
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate artifacts.md to docs/ directory
          poetry run python scripts/generate_artifacts_page.py "${{ github.repository }}"
  
          # Run gendoc to prepare docs
          make gendoc

          # Build with MkDocs to get proper styling
          poetry run mkdocs build

          # Copy the artifacts page HTML into the artifacts-pages deployment
          # This puts it at gh-pages/artifacts/index.html
          cp site/artifacts/index.html artifacts-pages/

      - name: Deploy artifacts and documentation to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./artifacts-pages
          publish_branch: gh-pages
          destination_dir: artifacts
          keep_files: true
          commit_message: "Deploy artifacts for ${{ github.event.release.tag_name }}"

      # 2. Create downloadable archives for release assets
      - name: Create artifact archives
        run: |
          cd project
          for schema in */; do
            schema_name="${schema%/}"
            tar -czf "../${schema_name}-artifacts.tar.gz" "$schema_name"
            zip -r "../${schema_name}-artifacts.zip" "$schema_name"
          done
          cd ..

      - name: Upload to release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in *-artifacts.tar.gz *-artifacts.zip; do
            gh release upload ${{ github.event.release.tag_name }} "$file" --clobber
          done

      # 3. Publish to PyPI
      - name: Build Python package
        run: poetry build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.2.2
        with:
          user: __token__
          password: ${{ secrets.PYPI_PASSWORD }}
