---
name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  release:
    name: Build and publish release artifacts
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install Poetry
        run: |
          pipx install poetry
          poetry self add "poetry-dynamic-versioning[plugin]"

      - name: Install dependencies
        run: poetry install --no-interaction

      # Generate artifacts once, use everywhere
      - name: Generate project artifacts
        run: make gen-project

      # Update artifacts documentation page
      - name: Update artifacts.md with new version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          python3 scripts/update_artifacts_page.py "$VERSION" "${{ github.repository }}"

      # 1. Deploy to GitHub Pages for permanent URLs
      - name: Prepare artifacts for GitHub Pages
        run: |
          mkdir -p artifacts-pages
          VERSION="${{ github.event.release.tag_name }}"
          
          echo "Deploying version: $VERSION"
          
          # Copy to versioned directory and latest
          cp -r project/* "artifacts-pages/$VERSION/"
          cp -r project/* "artifacts-pages/latest/"
          
          # Create root index that redirects to docs
          cat > artifacts-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>OSC-EM Schema Artifacts</title>
            <meta http-equiv="refresh" content="0; url=https://osc-em.github.io/oscem-schemas/artifacts.html">
          </head>
          <body>
            <p>Redirecting to <a href="https://osc-em.github.io/oscem-schemas/artifacts.html">artifacts documentation</a>...</p>
          </body>
          </html>
          EOF
          
          # Create index for latest version
          cat > "artifacts-pages/latest/index.html" << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>OSC-EM Schema Artifacts - Latest</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
              .description { color: #666; font-size: 14px; margin-left: 10px; }
            </style>
          </head>
          <body>
            <h1>OSC-EM Schema Artifacts - Latest Version</h1>
            <p>Select a schema type to browse:</p>
            <ul>
              <li><a href="spa/">Single Particle Analysis (SPA)</a> <span class="description">- Schemas for single particle cryo-EM</span></li>
              <li><a href="cellular_tomo/">Cellular Tomography</a> <span class="description">- Schemas for cellular cryo-tomography</span></li>
              <li><a href="env_tomo/">Environmental Tomography</a> <span class="description">- Schemas for environmental tomography</span></li>
              <li><a href="subtomo/">Sub-Tomogram Averaging</a> <span class="description">- Schemas for sub-tomogram averaging</span></li>
              <li><a href="general/">General</a> <span class="description">- General schemas and shared definitions</span></li>
            </ul>
            <p><a href="https://osc-em.github.io/oscem-schemas/artifacts.html">← Back to all versions</a></p>
          </body>
          </html>
          EOF
          
          # Create the same index for versioned directory
          cat > "artifacts-pages/$VERSION/index.html" << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>OSC-EM Schema Artifacts - $VERSION</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
              .description { color: #666; font-size: 14px; margin-left: 10px; }
            </style>
          </head>
          <body>
            <h1>OSC-EM Schema Artifacts - $VERSION</h1>
            <p>Select a schema type to browse:</p>
            <ul>
              <li><a href="spa/">Single Particle Analysis (SPA)</a> <span class="description">- Schemas for single particle cryo-EM</span></li>
              <li><a href="cellular_tomo/">Cellular Tomography</a> <span class="description">- Schemas for cellular cryo-tomography</span></li>
              <li><a href="env_tomo/">Environmental Tomography</a> <span class="description">- Schemas for environmental tomography</span></li>
              <li><a href="subtomo/">Sub-Tomogram Averaging</a> <span class="description">- Schemas for sub-tomogram averaging</span></li>
              <li><a href="general/">General</a> <span class="description">- General schemas and shared definitions</span></li>
            </ul>
            <p><a href="https://osc-em.github.io/oscem-schemas/artifacts.html">← Back to all versions</a></p>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./artifacts-pages
          publish_branch: gh-pages
          destination_dir: artifacts
          keep_files: true
          commit_message: "Deploy artifacts for ${{ github.event.release.tag_name }}"

      # Commit updated artifacts.md back to repository
      - name: Commit updated artifacts page
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add perm_docs/artifacts.md
          git diff --staged --quiet || git commit -m "docs: Update artifacts.md with version ${{ github.event.release.tag_name }}"
          git push

      # 2. Create downloadable archives for release assets
      - name: Create artifact archives
        run: |
          cd project
          for schema in */; do
            schema_name="${schema%/}"
            tar -czf "../${schema_name}-artifacts.tar.gz" "$schema_name"
            zip -r "../${schema_name}-artifacts.zip" "$schema_name"
          done
          cd ..

      - name: Upload to release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in *-artifacts.tar.gz *-artifacts.zip; do
            gh release upload ${{ github.event.release.tag_name }} "$file" --clobber
          done

      # 3. Publish to PyPI
      - name: Build Python package
        run: poetry build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.2.2
        with:
          user: __token__
          password: ${{ secrets.PYPI_PASSWORD }}
